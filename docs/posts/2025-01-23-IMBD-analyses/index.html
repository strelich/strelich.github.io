<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jack Strelich">
<meta name="dcterms.date" content="2025-01-23">
<meta name="description" content="Wrangling IMBD data and modelling with tidymodels">

<title>Jack Strelich, Data Scientist - IMDB Data Wrangling</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link href="../../site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="../../site_libs/pagedtable-1.1/js/pagedtable.js"></script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Jack Strelich, Data Scientist</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About Me</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html"> 
<span class="menu-text">Posts</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">IMDB Data Wrangling</h1>
                  <div>
        <div class="description">
          Wrangling IMBD data and modelling with tidymodels
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">R</div>
                <div class="quarto-category">Data Cleaning</div>
                <div class="quarto-category">Data Visualization</div>
                <div class="quarto-category">Analysis</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Jack Strelich </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">January 23, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#gather-data" id="toc-gather-data" class="nav-link active" data-scroll-target="#gather-data">Gather data</a>
  <ul class="collapse">
  <li><a href="#imdb" id="toc-imdb" class="nav-link" data-scroll-target="#imdb">IMDB</a></li>
  <li><a href="#box-office-mojo" id="toc-box-office-mojo" class="nav-link" data-scroll-target="#box-office-mojo">Box Office Mojo</a></li>
  <li><a href="#join-data-sets" id="toc-join-data-sets" class="nav-link" data-scroll-target="#join-data-sets">Join data sets</a></li>
  </ul></li>
  <li><a href="#explore" id="toc-explore" class="nav-link" data-scroll-target="#explore">Explore</a>
  <ul class="collapse">
  <li><a href="#descriptives" id="toc-descriptives" class="nav-link" data-scroll-target="#descriptives">Descriptives</a></li>
  <li><a href="#visualization" id="toc-visualization" class="nav-link" data-scroll-target="#visualization">Visualization</a></li>
  </ul></li>
  <li><a href="#model" id="toc-model" class="nav-link" data-scroll-target="#model">Model</a>
  <ul class="collapse">
  <li><a href="#lifetime-gross" id="toc-lifetime-gross" class="nav-link" data-scroll-target="#lifetime-gross">Lifetime gross</a></li>
  <li><a href="#average-ratings" id="toc-average-ratings" class="nav-link" data-scroll-target="#average-ratings">Average ratings</a>
  <ul class="collapse">
  <li><a href="#linear-model" id="toc-linear-model" class="nav-link" data-scroll-target="#linear-model">Linear model</a></li>
  <li><a href="#random-forest" id="toc-random-forest" class="nav-link" data-scroll-target="#random-forest">Random forest</a></li>
  <li><a href="#xgboost" id="toc-xgboost" class="nav-link" data-scroll-target="#xgboost">XGBoost</a></li>
  <li><a href="#compare" id="toc-compare" class="nav-link" data-scroll-target="#compare">Compare</a></li>
  </ul></li>
  <li><a href="#predicting-genre" id="toc-predicting-genre" class="nav-link" data-scroll-target="#predicting-genre">Predicting genre</a>
  <ul class="collapse">
  <li><a href="#glm" id="toc-glm" class="nav-link" data-scroll-target="#glm">GLM</a></li>
  <li><a href="#random-forest-1" id="toc-random-forest-1" class="nav-link" data-scroll-target="#random-forest-1">Random forest</a></li>
  <li><a href="#xgboost-1" id="toc-xgboost-1" class="nav-link" data-scroll-target="#xgboost-1">XGBoost</a></li>
  <li><a href="#compare-1" id="toc-compare-1" class="nav-link" data-scroll-target="#compare-1">Compare</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#wrapping-up" id="toc-wrapping-up" class="nav-link" data-scroll-target="#wrapping-up">Wrapping up</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>Today, I’ll explore some data on movies from <a href="https://developer.imdb.com/non-commercial-datasets/">IMDB</a> and <a href="https://www.boxofficemojo.com/chart/top_lifetime_gross/">Box Office Mojo</a>. I’ll begin with some quick data wrangling, then walk through modelling the data with the <code>tidymodels</code> package. I’ve been experimenting with this package a lot recently, and am particularly impressed by how it streamlines running multiple models and comparing the results. Note that this won’t be a full-fledged tutorial for <code>tidymodels</code> (the <code>tidymodels</code> <a href="https://www.tidymodels.org/start/">docs</a> cover that very well) nor a deep dive into the models themselves, but more of a worked example.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load packages</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels) <span class="co"># Modelling</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom) <span class="co"># Extracting coefficients</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(yardstick) <span class="co"># Evaluating models</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vip) <span class="co"># Variable importance</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rvest) <span class="co"># For webscraping</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse) <span class="co"># Data wrangling</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggrepel) <span class="co"># Extra data viz</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Set theme for plots</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_minimal</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="gather-data" class="level1">
<h1>Gather data</h1>
<section id="imdb" class="level2">
<h2 class="anchored" data-anchor-id="imdb">IMDB</h2>
<p>The <a href="https://developer.imdb.com/non-commercial-datasets/">IMDB Non-Commercial Datasets</a> page lists the data sets available, as well as a dictionary for each one. Six data sets contain information about titles (movie, TV show, video game, etc.) and one contains info about individuals. These data sets are quite large; the ratings data includes about 1.5 million titles, and the individuals data includes over 14 million names. To keep things tractable, we’ll limit our exploration to movies with at least 1000 individual ratings (“votes”).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read ratings data</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>ratings_dat <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(<span class="st">"https://datasets.imdbws.com/title.ratings.tsv.gz"</span>,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(numVotes <span class="sc">&gt;=</span> <span class="dv">1000</span>) <span class="co"># Only titles with at least 1000 votes</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Read names data</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>names_dat <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(<span class="st">"https://datasets.imdbws.com/name.basics.tsv.gz"</span>, </span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>                      <span class="at">show_col_types =</span> <span class="cn">FALSE</span>,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>                      <span class="at">na =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">N"</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Read crew data</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>crew_dat <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(<span class="st">"https://datasets.imdbws.com/title.crew.tsv.gz"</span>, </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>                     <span class="at">show_col_types =</span> <span class="cn">FALSE</span>,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>                     <span class="at">na =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">N"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For the main title data set (<code>title.basics.tsv.gz</code>), we’ll do a little more data cleaning up front. Specifically, we’ll:</p>
<ul>
<li>Limit ourselves to movies (i.e., excluding TV shows, video games, and other types of media)</li>
<li>Exclude adult content (keeping thing SFW!)</li>
<li>Read release year and run time as integers</li>
<li>Split the <code>genres</code> column (currently a series of comma-separated tags) into multiple binary variables (1 if the tag applies, 0 otherwise)</li>
</ul>
<p>Using <a href="https://www.tidyverse.org/blog/2021/11/readr-2-1-0-lazy/">lazy reading</a> via the <code>lazy = TRUE</code> argument to <code>read_tsv()</code> helps to speed up this process, although in my experience the real bottleneck is downloading the data in the first place.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>title_dat <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(<span class="st">"https://datasets.imdbws.com/title.basics.tsv.gz"</span>,</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">na =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">N"</span>,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">show_col_types =</span> <span class="cn">FALSE</span>,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">lazy =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> <span class="co"># Don't load everything into memory!</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(titleType <span class="sc">==</span> <span class="st">"movie"</span>, <span class="co"># Only movies</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>         isAdult <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> <span class="co"># Not adult!</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">startYear =</span> <span class="fu">as.integer</span>(startYear),</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">runtimeMinutes =</span> <span class="fu">as.integer</span>(runtimeMinutes)) <span class="sc">%&gt;%</span> </span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(isAdult,endYear)) <span class="sc">%&gt;%</span> <span class="co"># Drop unneeded columns</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate_longer_delim</span>(genres, <span class="at">delim =</span> <span class="st">","</span>) <span class="sc">%&gt;%</span> <span class="co"># Split tags into multiple rows</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">temp=</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="co"># Create column of 1s</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> genres, <span class="co"># Make wider; one column per genre</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_from =</span> temp,</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_fill =</span> <span class="dv">0</span>,</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>              <span class="at">names_prefix =</span> <span class="st">"Genre_"</span>) <span class="co"># Set naming convention for new columns</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: There was 1 warning in `filter()`.
ℹ In argument: `titleType == "movie"`.
Caused by warning:
! One or more parsing issues, call `problems()` on your data frame for details,
e.g.:
  dat &lt;- vroom(...)
  problems(dat)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check work</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>title_dat <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["tconst"],"name":[1],"type":["chr"],"align":["left"]},{"label":["titleType"],"name":[2],"type":["chr"],"align":["left"]},{"label":["primaryTitle"],"name":[3],"type":["chr"],"align":["left"]},{"label":["originalTitle"],"name":[4],"type":["chr"],"align":["left"]},{"label":["startYear"],"name":[5],"type":["int"],"align":["right"]},{"label":["runtimeMinutes"],"name":[6],"type":["int"],"align":["right"]},{"label":["Genre_Romance"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["Genre_Documentary"],"name":[8],"type":["dbl"],"align":["right"]},{"label":["Genre_News"],"name":[9],"type":["dbl"],"align":["right"]},{"label":["Genre_Sport"],"name":[10],"type":["dbl"],"align":["right"]},{"label":["Genre_NA"],"name":[11],"type":["dbl"],"align":["right"]},{"label":["Genre_Action"],"name":[12],"type":["dbl"],"align":["right"]},{"label":["Genre_Adventure"],"name":[13],"type":["dbl"],"align":["right"]},{"label":["Genre_Biography"],"name":[14],"type":["dbl"],"align":["right"]},{"label":["Genre_Drama"],"name":[15],"type":["dbl"],"align":["right"]},{"label":["Genre_Fantasy"],"name":[16],"type":["dbl"],"align":["right"]},{"label":["Genre_Comedy"],"name":[17],"type":["dbl"],"align":["right"]},{"label":["Genre_War"],"name":[18],"type":["dbl"],"align":["right"]},{"label":["Genre_Crime"],"name":[19],"type":["dbl"],"align":["right"]},{"label":["Genre_Family"],"name":[20],"type":["dbl"],"align":["right"]},{"label":["Genre_History"],"name":[21],"type":["dbl"],"align":["right"]},{"label":["Genre_Sci-Fi"],"name":[22],"type":["dbl"],"align":["right"]},{"label":["Genre_Thriller"],"name":[23],"type":["dbl"],"align":["right"]},{"label":["Genre_Western"],"name":[24],"type":["dbl"],"align":["right"]},{"label":["Genre_Mystery"],"name":[25],"type":["dbl"],"align":["right"]},{"label":["Genre_Horror"],"name":[26],"type":["dbl"],"align":["right"]},{"label":["Genre_Music"],"name":[27],"type":["dbl"],"align":["right"]},{"label":["Genre_Animation"],"name":[28],"type":["dbl"],"align":["right"]},{"label":["Genre_Musical"],"name":[29],"type":["dbl"],"align":["right"]},{"label":["Genre_Film-Noir"],"name":[30],"type":["dbl"],"align":["right"]},{"label":["Genre_Talk-Show"],"name":[31],"type":["dbl"],"align":["right"]},{"label":["Genre_Reality-TV"],"name":[32],"type":["dbl"],"align":["right"]},{"label":["Genre_Adult"],"name":[33],"type":["dbl"],"align":["right"]},{"label":["Genre_Game-Show"],"name":[34],"type":["dbl"],"align":["right"]}],"data":[{"1":"tt0000009","2":"movie","3":"Miss Jerry","4":"Miss Jerry","5":"1894","6":"45","7":"1","8":"0","9":"0","10":"0","11":"0","12":"0","13":"0","14":"0","15":"0","16":"0","17":"0","18":"0","19":"0","20":"0","21":"0","22":"0","23":"0","24":"0","25":"0","26":"0","27":"0","28":"0","29":"0","30":"0","31":"0","32":"0","33":"0","34":"0"},{"1":"tt0000147","2":"movie","3":"The Corbett-Fitzsimmons Fight","4":"The Corbett-Fitzsimmons Fight","5":"1897","6":"100","7":"0","8":"1","9":"1","10":"1","11":"0","12":"0","13":"0","14":"0","15":"0","16":"0","17":"0","18":"0","19":"0","20":"0","21":"0","22":"0","23":"0","24":"0","25":"0","26":"0","27":"0","28":"0","29":"0","30":"0","31":"0","32":"0","33":"0","34":"0"},{"1":"tt0000502","2":"movie","3":"Bohemios","4":"Bohemios","5":"1905","6":"100","7":"0","8":"0","9":"0","10":"0","11":"1","12":"0","13":"0","14":"0","15":"0","16":"0","17":"0","18":"0","19":"0","20":"0","21":"0","22":"0","23":"0","24":"0","25":"0","26":"0","27":"0","28":"0","29":"0","30":"0","31":"0","32":"0","33":"0","34":"0"},{"1":"tt0000574","2":"movie","3":"The Story of the Kelly Gang","4":"The Story of the Kelly Gang","5":"1906","6":"70","7":"0","8":"0","9":"0","10":"0","11":"0","12":"1","13":"1","14":"1","15":"0","16":"0","17":"0","18":"0","19":"0","20":"0","21":"0","22":"0","23":"0","24":"0","25":"0","26":"0","27":"0","28":"0","29":"0","30":"0","31":"0","32":"0","33":"0","34":"0"},{"1":"tt0000591","2":"movie","3":"The Prodigal Son","4":"L'enfant prodigue","5":"1907","6":"90","7":"0","8":"0","9":"0","10":"0","11":"0","12":"0","13":"0","14":"0","15":"1","16":"0","17":"0","18":"0","19":"0","20":"0","21":"0","22":"0","23":"0","24":"0","25":"0","26":"0","27":"0","28":"0","29":"0","30":"0","31":"0","32":"0","33":"0","34":"0"},{"1":"tt0000615","2":"movie","3":"Robbery Under Arms","4":"Robbery Under Arms","5":"1907","6":"NA","7":"0","8":"0","9":"0","10":"0","11":"0","12":"0","13":"0","14":"0","15":"1","16":"0","17":"0","18":"0","19":"0","20":"0","21":"0","22":"0","23":"0","24":"0","25":"0","26":"0","27":"0","28":"0","29":"0","30":"0","31":"0","32":"0","33":"0","34":"0"},{"1":"tt0000630","2":"movie","3":"Hamlet","4":"Amleto","5":"1908","6":"NA","7":"0","8":"0","9":"0","10":"0","11":"0","12":"0","13":"0","14":"0","15":"1","16":"0","17":"0","18":"0","19":"0","20":"0","21":"0","22":"0","23":"0","24":"0","25":"0","26":"0","27":"0","28":"0","29":"0","30":"0","31":"0","32":"0","33":"0","34":"0"},{"1":"tt0000675","2":"movie","3":"Don Quijote","4":"Don Quijote","5":"1908","6":"NA","7":"0","8":"0","9":"0","10":"0","11":"0","12":"0","13":"0","14":"0","15":"1","16":"0","17":"0","18":"0","19":"0","20":"0","21":"0","22":"0","23":"0","24":"0","25":"0","26":"0","27":"0","28":"0","29":"0","30":"0","31":"0","32":"0","33":"0","34":"0"},{"1":"tt0000679","2":"movie","3":"The Fairylogue and Radio-Plays","4":"The Fairylogue and Radio-Plays","5":"1908","6":"120","7":"0","8":"0","9":"0","10":"0","11":"0","12":"0","13":"1","14":"0","15":"0","16":"1","17":"0","18":"0","19":"0","20":"0","21":"0","22":"0","23":"0","24":"0","25":"0","26":"0","27":"0","28":"0","29":"0","30":"0","31":"0","32":"0","33":"0","34":"0"},{"1":"tt0000838","2":"movie","3":"A Cultura do Cacau","4":"A Cultura do Cacau","5":"1909","6":"NA","7":"0","8":"0","9":"0","10":"0","11":"1","12":"0","13":"0","14":"0","15":"0","16":"0","17":"0","18":"0","19":"0","20":"0","21":"0","22":"0","23":"0","24":"0","25":"0","26":"0","27":"0","28":"0","29":"0","30":"0","31":"0","32":"0","33":"0","34":"0"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section>
<section id="box-office-mojo" class="level2">
<h2 class="anchored" data-anchor-id="box-office-mojo">Box Office Mojo</h2>
<p>We’ll supplement the titles data with information on lifetime gross. Conveniently, <a href="https://www.boxofficemojo.com/chart/top_lifetime_gross/">Box Office Mojo</a> lists the top 1000 domestic films by lifetime gross; less conveniently, the information is in a paged table. To save a bunch of copying and pasting, we’ll do some basic webscraping to get this information into a single data frame.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create vector of URLs, one for each page of the table</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>URLs <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"https://www.boxofficemojo.com/chart/top_lifetime_gross/?offset="</span>, </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>               <span class="dv">0</span><span class="sc">:</span><span class="dv">4</span><span class="sc">*</span><span class="dv">200</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop over URLs</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>top_gross <span class="ot">&lt;-</span> <span class="fu">map</span>(</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  URLs, \(url) </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_html</span>(url) <span class="sc">%&gt;%</span> <span class="co"># For each URL...</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">html_elements</span>(<span class="st">"table"</span>) <span class="sc">%&gt;%</span> <span class="co"># Pick out the table</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">html_table</span>() <span class="sc">%&gt;%</span> <span class="co"># Read the table as a list</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pluck</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="co"># Get the first element (the actual data)</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove commas and make into integers</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Rank=</span><span class="fu">str_remove</span>(Rank,<span class="st">"</span><span class="sc">\\</span><span class="st">,"</span>) <span class="sc">%&gt;%</span> <span class="fu">as.integer</span>(), </span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">Lifetime Gross</span><span class="st">`</span><span class="ot">=</span><span class="fu">str_remove_all</span>(<span class="st">`</span><span class="at">Lifetime Gross</span><span class="st">`</span>,<span class="st">"</span><span class="sc">\\</span><span class="st">,|</span><span class="sc">\\</span><span class="st">$"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>             <span class="fu">as.integer</span>())) <span class="sc">%&gt;%</span> </span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list_rbind</span>() <span class="co"># Combine into single data frame</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Check work</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>top_gross <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["Rank"],"name":[1],"type":["int"],"align":["right"]},{"label":["Title"],"name":[2],"type":["chr"],"align":["left"]},{"label":["Lifetime Gross"],"name":[3],"type":["int"],"align":["right"]},{"label":["Year"],"name":[4],"type":["int"],"align":["right"]}],"data":[{"1":"1","2":"Star Wars: Episode VII - The Force Awakens","3":"936662225","4":"2015"},{"1":"2","2":"Avengers: Endgame","3":"858373000","4":"2019"},{"1":"3","2":"Spider-Man: No Way Home","3":"814866759","4":"2021"},{"1":"4","2":"Avatar","3":"785221649","4":"2009"},{"1":"5","2":"Top Gun: Maverick","3":"718732821","4":"2022"},{"1":"6","2":"Black Panther","3":"700426566","4":"2018"},{"1":"7","2":"Avatar: The Way of Water","3":"684075767","4":"2022"},{"1":"8","2":"Avengers: Infinity War","3":"678815482","4":"2018"},{"1":"9","2":"Titanic","3":"674292608","4":"1997"},{"1":"10","2":"Jurassic World","3":"653406625","4":"2015"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section>
<section id="join-data-sets" class="level2">
<h2 class="anchored" data-anchor-id="join-data-sets">Join data sets</h2>
<p>Let’s join our title (<code>title_dat</code>), ratings (<code>ratings_dat</code>), and domestic gross (<code>top_gross</code>) data sets into a single data frame. <code>title_dat</code> and <code>ratings_dat</code> will automatically join using the unique title identifiers (<code>tconst</code>) present in both data sets. For the domestic gross data, we’ll join by title and release year; because these variables have different names in the title data and domestic gross data (<code>originalTitle</code> versus <code>Title</code> and <code>startYear</code> versus <code>Year</code>), we’ll need to specify which columns in each data set are equivalent, using <code>join_by()</code>.</p>
<p>Note the use of <code>inner_join()</code> to join the title and rating data; this ensures that we retain only titles that have ratings associated with them (and at least 1000 votes, thanks to our earlier filtering of the ratings data). In contrast, we join the domestic gross data using <code>left_join()</code>, meaning that we retain titles from the title data even if they don’t appear in the domestic gross data.</p>
<p>Lastly, we’ll join <code>crew_dat</code> to get unique identifiers for each movie’s director, then join <code>names_dat</code> to get the actual names associated with each identifier<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>title_dat <span class="ot">&lt;-</span> title_dat <span class="sc">%&gt;%</span> <span class="co"># Start with title data set  </span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(ratings_dat) <span class="sc">%&gt;%</span> <span class="co"># Join ratings data set (use tconst as key)</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(top_gross,  <span class="co"># Join gross data set</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">join_by</span>(originalTitle <span class="sc">==</span> Title, <span class="co"># Col names differ -- specify!</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                         startYear <span class="sc">==</span> Year)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(crew_dat) <span class="sc">%&gt;%</span> <span class="co"># Join crew data set</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(<span class="fu">select</span>(names_dat, <span class="co"># Names!</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>                   <span class="at">directors=</span>nconst, <span class="co"># Rename variables to match</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>                   <span class="at">Director=</span>primaryName)) <span class="sc">%&gt;%</span>  </span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(tconst, primaryTitle<span class="sc">:</span>runtimeMinutes, averageRating, numVotes, <span class="co"># Reorganize columns</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>         <span class="st">`</span><span class="at">Lifetime Gross</span><span class="st">`</span>, Director, <span class="fu">starts_with</span>(<span class="st">"Genre"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(tconst)`
Joining with `by = join_by(tconst)`
Joining with `by = join_by(directors)`</code></pre>
</div>
</div>
</section>
</section>
<section id="explore" class="level1">
<h1>Explore</h1>
<section id="descriptives" class="level2">
<h2 class="anchored" data-anchor-id="descriptives">Descriptives</h2>
<p>Let’s check our work thus far via <code>glimpse()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>title_dat <span class="sc">%&gt;%</span> <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 44,716
Columns: 37
$ tconst             &lt;chr&gt; "tt0002130", "tt0002423", "tt0002844", "tt0003014",…
$ primaryTitle       &lt;chr&gt; "Dante's Inferno", "Passion", "Fantômas: In the Sha…
$ originalTitle      &lt;chr&gt; "L'inferno", "Madame DuBarry", "Fantômas I: À l'omb…
$ startYear          &lt;int&gt; 1911, 1919, 1913, 1913, 1913, 1913, 1913, 1914, 191…
$ runtimeMinutes     &lt;int&gt; 71, 113, 54, 96, 61, 90, 85, 78, 148, 52, 59, 70, 6…
$ averageRating      &lt;dbl&gt; 7.0, 6.6, 6.9, 7.0, 6.9, 6.9, 6.4, 6.4, 7.1, 6.0, 6…
$ numVotes           &lt;dbl&gt; 3704, 1049, 2598, 1493, 1765, 1405, 2522, 1493, 409…
$ `Lifetime Gross`   &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ Director           &lt;chr&gt; NA, "Ernst Lubitsch", "Louis Feuillade", "Victor Sj…
$ Genre_Romance      &lt;dbl&gt; 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, …
$ Genre_Documentary  &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
$ Genre_News         &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
$ Genre_Sport        &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
$ Genre_NA           &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
$ Genre_Action       &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, …
$ Genre_Adventure    &lt;dbl&gt; 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, …
$ Genre_Biography    &lt;dbl&gt; 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
$ Genre_Drama        &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, …
$ Genre_Fantasy      &lt;dbl&gt; 1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, …
$ Genre_Comedy       &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, …
$ Genre_War          &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
$ Genre_Crime        &lt;dbl&gt; 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, …
$ Genre_Family       &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
$ Genre_History      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, …
$ `Genre_Sci-Fi`     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
$ Genre_Thriller     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
$ Genre_Western      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
$ Genre_Mystery      &lt;dbl&gt; 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
$ Genre_Horror       &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, …
$ Genre_Music        &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
$ Genre_Animation    &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
$ Genre_Musical      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
$ `Genre_Film-Noir`  &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
$ `Genre_Talk-Show`  &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
$ `Genre_Reality-TV` &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
$ Genre_Adult        &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
$ `Genre_Game-Show`  &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …</code></pre>
</div>
</div>
<p>We see the following variables:</p>
<ul>
<li><code>tconst</code>: unique identifier for each movie</li>
<li><code>primaryTitle</code>: main title by which the movie is known <!-- - `originalTitle`: original title of movie (e.g., non-English title) --></li>
<li><code>startYear</code>: year movie was released</li>
<li><code>runtimeMinutes</code>: movie’s runtime, in minutes (natch)</li>
<li><code>averageRating</code>: average of all ratings (1-10 scale)</li>
<li><code>numVotes</code>: total number of ratings received</li>
<li><code>Lifetime Gross</code>: lifetime domestic gross of movie; only available for the top 1000 highest-grossing movies in our data set</li>
<li><code>Director</code>: name of movie’s director; <code>NA</code> if more than one director</li>
<li><code>Genre_X</code>: genre tags (<code>1</code> if the tag applies, <code>0</code> otherwise)</li>
</ul>
<p>We can get a quick-and-dirty overview of our continuous variables via <code>summary()</code>, and a breakdown of the distributions of (and correlations<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> between) these variables via <code>GGally::ggpairs()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>title_dat <span class="sc">%&gt;%</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="st">"startYear"</span>,<span class="st">"runtimeMinutes"</span>,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>         <span class="st">"averageRating"</span>,<span class="st">"numVotes"</span>,<span class="st">"Lifetime Gross"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   startYear    runtimeMinutes  averageRating     numVotes      
 Min.   :1911   Min.   : 39.0   Min.   :1.00   Min.   :   1000  
 1st Qu.:1989   1st Qu.: 91.0   1st Qu.:5.60   1st Qu.:   1673  
 Median :2008   Median :100.0   Median :6.40   Median :   3334  
 Mean   :2000   Mean   :105.2   Mean   :6.24   Mean   :  25486  
 3rd Qu.:2017   3rd Qu.:115.0   3rd Qu.:7.10   3rd Qu.:  10645  
 Max.   :2025   Max.   :776.0   Max.   :9.80   Max.   :2994771  
                NA's   :84                                      
 Lifetime Gross     
 Min.   : 85297000  
 1st Qu.:105874210  
 Median :137275620  
 Mean   :174204573  
 3rd Qu.:196461860  
 Max.   :936662225  
 NA's   :43757      </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>title_dat <span class="sc">%&gt;%</span> </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="st">"startYear"</span>,<span class="st">"runtimeMinutes"</span>,</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>         <span class="st">"averageRating"</span>,<span class="st">"numVotes"</span>,<span class="st">"Lifetime Gross"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  GGally<span class="sc">::</span><span class="fu">ggpairs</span>(</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">lower =</span> <span class="fu">list</span>(<span class="at">continuous =</span> GGally<span class="sc">::</span><span class="fu">wrap</span>(<span class="st">"points"</span>, <span class="co"># Handle overplotting</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">alpha =</span> <span class="fl">0.1</span>, </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">size =</span> <span class="dv">1</span>)),</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">upper =</span> <span class="fu">list</span>(<span class="at">continuous =</span> GGally<span class="sc">::</span><span class="fu">wrap</span>(GGally<span class="sc">::</span>ggally_cor, </span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">method =</span> <span class="st">"spearman"</span>,</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">use =</span> <span class="st">"pairwise"</span>,</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">title =</span> <span class="st">"Rho"</span>))</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Distributions and correlations of continuous variables"</span>,</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>           <span class="at">caption =</span> <span class="st">"Data from datasets.imdbws.com"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Major takeaways:</p>
<ul>
<li><code>startYear</code>: most movies in the data set are relatively recent (post-2008)</li>
<li><code>runtimeMinutes</code>: extreme positive skew. Digging around in the raw data, I found a handful of cases where a miniseries was treated as a single movie, or where the date was copied into the runtime column, but also at least one 25-hour-long movie!</li>
<li><code>numVotes</code>: extreme positive skew!</li>
<li>Correlations between these variables are statistically significant, but small enough that we shouldn’t have glaring issues with multicollinearity (although the correlation between <code>numVotes</code> and <code>Lifetime Gross</code> is potentially troublesome).</li>
</ul>
</section>
<section id="visualization" class="level2">
<h2 class="anchored" data-anchor-id="visualization">Visualization</h2>
<p>Let’s start by examining which movies got the most votes overall. Because we joined the crew data, we can also include directors’ names in the plot!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Most votes overall</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>title_dat <span class="sc">%&gt;%</span> </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(<span class="at">order_by =</span> numVotes, <span class="at">n =</span> <span class="dv">20</span>) <span class="sc">%&gt;%</span> <span class="co"># Top 20 films</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Label =</span> <span class="fu">paste0</span>(primaryTitle,<span class="st">"</span><span class="sc">\n</span><span class="st">("</span>,Director,<span class="st">")"</span>)) <span class="sc">%&gt;%</span> <span class="co"># Add directors</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">fct_inorder</span>(Label) <span class="sc">%&gt;%</span> fct_rev, <span class="at">y =</span> numVotes)) <span class="sc">+</span> </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill=</span><span class="st">"dodgerblue"</span>) <span class="sc">+</span> </span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">format</span>(numVotes,<span class="at">big.mark =</span> <span class="st">","</span>)), </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">nudge_y =</span> <span class="sc">-</span><span class="dv">3</span><span class="sc">*</span><span class="dv">10</span><span class="sc">^</span><span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span> </span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_number</span>(<span class="at">big.mark =</span> <span class="st">","</span>)) <span class="sc">+</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Movie"</span>, <span class="at">y=</span><span class="st">"Total votes"</span>, </span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Top 20 movies by number of votes"</span>,</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">"Data from datasets.imdbws.com"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Unsurprisingly, we see a mix of (relatively) recent blockbusters such as <em>Interstellar</em> and <em>The Wolf of Wall Street</em> as well as older classics like <em>The Godfather</em> and <em>Silence of the Lambs</em>.</p>
<p>Next, let’s look at the relationship between ratings and lifetime gross. We’ll use <code>ggrepel::geom_text_repel()</code> to label the highest-grossing films (those making more than $500 million).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>title_dat <span class="sc">%&gt;%</span> </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(<span class="st">`</span><span class="at">Lifetime Gross</span><span class="st">`</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> averageRating, <span class="at">y =</span> <span class="st">`</span><span class="at">Lifetime Gross</span><span class="st">`</span>)) <span class="sc">+</span> </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()<span class="sc">+</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text_repel</span>(<span class="at">data =</span> <span class="fu">filter</span>(title_dat, <span class="st">`</span><span class="at">Lifetime Gross</span><span class="st">`</span> <span class="sc">&gt;</span> <span class="dv">500000000</span>), </span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">aes</span>(<span class="at">label =</span> primaryTitle),</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">color =</span> <span class="st">"firebrick"</span>) <span class="sc">+</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_dollar</span>()) <span class="sc">+</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Average rating"</span>,</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Lifetime domestic gross"</span>,</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Lifetime domestic gross by average rating"</span>,</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">"Includes only top 1000 movies by lifetime domestic gross.</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="st">       Data from datasets.imdbws.com and boxofficemojo.com/chart/top_lifetime_gross"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: ggrepel: 1 unlabeled data points (too many overlaps). Consider
increasing max.overlaps</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Finally, let’s look at the frequency of each genre tag in the data set:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>title_dat <span class="sc">%&gt;%</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"Genre_"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(), <span class="at">names_prefix =</span> <span class="st">"Genre_"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(value<span class="sc">==</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(name, <span class="at">sort =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> <span class="co"># Get frequency of each tag</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span><span class="fu">fct_rev</span>(<span class="fu">fct_inorder</span>(name)),<span class="at">y=</span>n)) <span class="sc">+</span> <span class="co"># Order by frequency</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill=</span><span class="st">"darkblue"</span>) <span class="sc">+</span> </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">ifelse</span>(n<span class="sc">&gt;</span><span class="dv">3000</span>, n<span class="dv">-1500</span>, n<span class="sc">+</span><span class="dv">1000</span>), <span class="at">color =</span> n <span class="sc">&gt;</span> <span class="dv">3000</span>,</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="fu">format</span>(n,<span class="at">big.mark =</span> <span class="st">","</span>))) <span class="sc">+</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_number</span>(<span class="at">big.mark =</span> <span class="st">","</span>)) <span class="sc">+</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"black"</span>,<span class="st">"white"</span>)) <span class="sc">+</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Genre"</span>, <span class="at">y =</span> <span class="st">"Frequency"</span>,</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Frequency of genre tags"</span>,</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">"Data from datasets.imdbws.com"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Drama and comedy are the most frequent tags by a pretty substantial margin!</p>
</section>
</section>
<section id="model" class="level1">
<h1>Model</h1>
<p>Let’s shift gears and try building some models with this data via <code>tidymodels</code>. As I mentioned earlier, this won’t be a full tutorial for <code>tidymodels</code> or a deep dive into the models themselves, but rather a worked example of how <code>tidymodels</code> allows us to easily run and compare multiple models. Take our findings with a grain of salt; these models will be very quick, back-of-the-envelope affairs, and we’ll skip over a lot of the steps we’d take if we were actually trying to make significant real-world decisions based on the outputs.</p>
<section id="lifetime-gross" class="level2">
<h2 class="anchored" data-anchor-id="lifetime-gross">Lifetime gross</h2>
<p>To start, let’s make a model to investigate which variables best predict lifetime gross. Because we only have lifetime gross data for the 1000 highest grossing movies in our data set, this will substantially decrease our sample size:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define our data set</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>gross_dat <span class="ot">&lt;-</span> title_dat <span class="sc">%&gt;%</span> </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(runtimeMinutes <span class="sc">&lt;</span> <span class="dv">300</span>, <span class="co"># Drop movies over 5hrs long...</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>         <span class="sc">!</span><span class="fu">is.na</span>(startYear), <span class="co"># Those missing release year...</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>         <span class="sc">!</span><span class="fu">is.na</span>(<span class="st">`</span><span class="at">Lifetime Gross</span><span class="st">`</span>)) <span class="sc">%&gt;%</span> <span class="co"># And those missing gross data</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(tconst,</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>         primaryTitle,</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">gross =</span> <span class="st">`</span><span class="at">Lifetime Gross</span><span class="st">`</span>,</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>         averageRating,</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>         numVotes,</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>         startYear, </span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>         runtimeMinutes, </span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>         <span class="fu">starts_with</span>(<span class="st">"Genre_"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="st">'Genre_News'</span>, <span class="st">'Genre_NA'</span>, <span class="co"># Drop columns for genres that don't occur</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Genre_Talk-Show'</span>, <span class="st">'Genre_Reality-TV'</span>, <span class="st">'Genre_Game-Show'</span>))</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(gross_dat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 959
Columns: 30
$ tconst            &lt;chr&gt; "tt0029583", "tt0031381", "tt0034492", "tt0042332", …
$ primaryTitle      &lt;chr&gt; "Snow White and the Seven Dwarfs", "Gone with the Wi…
$ gross             &lt;int&gt; 184925486, 200882193, 102247150, 93141149, 87404651,…
$ averageRating     &lt;dbl&gt; 7.6, 8.2, 7.3, 7.3, 7.3, 7.3, 7.3, 7.8, 7.9, 8.1, 8.…
$ numVotes          &lt;dbl&gt; 221758, 342617, 158217, 178774, 157776, 153329, 1875…
$ startYear         &lt;int&gt; 1937, 1939, 1942, 1950, 1953, 1955, 1961, 1964, 1965…
$ runtimeMinutes    &lt;int&gt; 83, 238, 69, 74, 77, 76, 79, 139, 197, 172, 106, 78,…
$ Genre_Romance     &lt;dbl&gt; 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0…
$ Genre_Documentary &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ Genre_Sport       &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ Genre_Action      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0…
$ Genre_Adventure   &lt;dbl&gt; 1, 0, 1, 0, 1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0…
$ Genre_Biography   &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0…
$ Genre_Drama       &lt;dbl&gt; 0, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0…
$ Genre_Fantasy     &lt;dbl&gt; 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ Genre_Comedy      &lt;dbl&gt; 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 1, 0…
$ Genre_War         &lt;dbl&gt; 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ Genre_Crime       &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0…
$ Genre_Family      &lt;dbl&gt; 1, 0, 0, 1, 1, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0…
$ Genre_History     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ `Genre_Sci-Fi`    &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ Genre_Thriller    &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0…
$ Genre_Western     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ Genre_Mystery     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ Genre_Horror      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1…
$ Genre_Music       &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ Genre_Animation   &lt;dbl&gt; 1, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0…
$ Genre_Musical     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ `Genre_Film-Noir` &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ Genre_Adult       &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…</code></pre>
</div>
</div>
<p>Next, we’ll define a recipe to preprocess our data. This recipe will:</p>
<ul>
<li>Predict lifetime gross (<code>gross</code>) from all other predictors</li>
<li>Treat <code>tconst</code> and <code>primaryTitle</code> as identifiers</li>
<li>Log-transform <code>gross</code> and <code>numVotes</code> to handle deviation from normality</li>
<li>Normalize all continuous predictors (i.e., convert to z-scores)</li>
<li>Remove predictors with no variance</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the recipe</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>lm_gross_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(gross <span class="sc">~</span> ., gross_dat) <span class="sc">%&gt;%</span> <span class="co"># Predict gross from all others</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(tconst,primaryTitle,<span class="at">new_role =</span> <span class="st">"ID"</span>) <span class="sc">%&gt;%</span> <span class="co"># Treat as identifiers</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_log</span>(gross, numVotes) <span class="sc">%&gt;%</span> <span class="co"># Log transform gross and number of votes</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(startYear,runtimeMinutes,numVotes,gross) <span class="sc">%&gt;%</span> <span class="co"># Normalize</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_zv</span>(<span class="fu">all_predictors</span>()) <span class="co"># Remove predictors with no variance</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we’ll fit the model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit model</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>lm_gross_fit <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(<span class="fu">linear_reg</span>()) <span class="sc">%&gt;%</span> <span class="co"># Use linear regression</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(lm_gross_rec) <span class="sc">%&gt;%</span> <span class="co"># Pre-process data via our recipie</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">data =</span> gross_dat) <span class="co"># Fit using our data set</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>lm_gross_fit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>══ Workflow [trained] ══════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: linear_reg()

── Preprocessor ────────────────────────────────────────────────────────────────
3 Recipe Steps

• step_log()
• step_normalize()
• step_zv()

── Model ───────────────────────────────────────────────────────────────────────

Call:
stats::lm(formula = ..y ~ ., data = data)

Coefficients:
      (Intercept)      averageRating           numVotes          startYear  
        -0.472949           0.039284           0.432938           0.112942  
   runtimeMinutes      Genre_Romance  Genre_Documentary        Genre_Sport  
         0.175688           0.009673           0.988917           0.050235  
     Genre_Action    Genre_Adventure    Genre_Biography        Genre_Drama  
         0.036221           0.341288          -0.202291          -0.134246  
    Genre_Fantasy       Genre_Comedy          Genre_War        Genre_Crime  
         0.231324           0.107008          -0.584406          -0.183351  
     Genre_Family      Genre_History     `Genre_Sci-Fi`     Genre_Thriller  
         0.067307          -0.197419           0.051611          -0.175678  
    Genre_Western      Genre_Mystery       Genre_Horror        Genre_Music  
        -0.132603          -0.362759           0.186564           0.113136  
  Genre_Animation      Genre_Musical  
         0.365934           0.154279  </code></pre>
</div>
</div>
<p>To make sense of the model results, let’s visualize our coefficients via a dot-and-whisker plot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>broom.mixed<span class="sc">::</span><span class="fu">tidy</span>(lm_gross_fit, <span class="at">conf.int =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> <span class="co"># Get coefficients and CIs</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(estimate) <span class="sc">%&gt;%</span> </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(estimate)) <span class="sc">%&gt;%</span> </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  dotwhisker<span class="sc">::</span><span class="fu">dwplot</span>(<span class="at">dot_args =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">"black"</span>),</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">whisker_args =</span> <span class="fu">list</span>(<span class="at">color =</span> <span class="st">"black"</span>),</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">vline =</span> <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, </span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">colour =</span> <span class="st">"grey50"</span>, </span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">linetype =</span> <span class="dv">2</span>)) <span class="sc">+</span> </span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Predicting lifetime gross"</span>, <span class="at">subtitle =</span> <span class="st">"Linear model"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Looking at the first few variables, a film being a documentary, animation, adventure, and/or fantasy seems to predict higher lifetime gross. Similarly, more votes overall, longer runtimes, and more recent release dates also seem to predict higher lifetime gross. The fact that being a documentary predicts higher lifetime gross seems a little odd – I don’t usually think of documentaries as huge moneymakers. To investigate, let’s see what documentaries are included in our data set for this model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>gross_dat <span class="sc">%&gt;%</span> </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Genre_Documentary <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(primaryTitle<span class="sc">:</span>runtimeMinutes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false"> <div class="table-caption"><p>Predicting lifetime gross - Documentaries</p></div>
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["primaryTitle"],"name":[1],"type":["chr"],"align":["left"]},{"label":["gross"],"name":[2],"type":["int"],"align":["right"]},{"label":["averageRating"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["numVotes"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["startYear"],"name":[5],"type":["int"],"align":["right"]},{"label":["runtimeMinutes"],"name":[6],"type":["int"],"align":["right"]}],"data":[{"1":"Space Station 3D","2":"93383953","3":"7.4","4":"1768","5":"2002","6":"47"},{"1":"Fahrenheit 9/11","2":"119194771","3":"7.5","4":"133399","5":"2004","6":"122"},{"1":"Jackass 3D","2":"117229692","3":"7.0","4":"69502","5":"2010","6":"94"},{"1":"Taylor Swift: The Eras Tour","2":"180756269","3":"8.0","4":"23719","5":"2023","6":"169"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Crucially, we only have four documentaries in our entire data set – this explains the very wide confidence interval for this coefficient in our dot-and-whisker plot. More to the point, the documentaries we have are an IMAX 3D feature about the International Space Station, a controversial Michael Moore documentary, Jackass 3D (self-explanatory), and a chronicle of Taylor Swift’s Eras Tour. Overall, I’d say we’re looking at a specific type of selection bias; the documentaries that make it into the top 1000 grossing films aren’t necessarily representative of documentaries in general.</p>
<p>Lastly, let’s look at the ten highest and lowest residuals in our results; these are the movies whose lifetime gross was most underestimated and overestimated (respectively) by the model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">augment</span>(lm_gross_fit, gross_dat) <span class="sc">%&gt;%</span> </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(.resid, <span class="at">n=</span><span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(.resid, .pred, primaryTitle<span class="sc">:</span>runtimeMinutes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false"> <div class="table-caption"><p>Predicting lifetime gross - Highest residuals</p></div>
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[".resid"],"name":[1],"type":["dbl"],"align":["right"]},{"label":[".pred"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["primaryTitle"],"name":[3],"type":["chr"],"align":["left"]},{"label":["gross"],"name":[4],"type":["int"],"align":["right"]},{"label":["averageRating"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["numVotes"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["startYear"],"name":[7],"type":["int"],"align":["right"]},{"label":["runtimeMinutes"],"name":[8],"type":["int"],"align":["right"]}],"data":[{"1":"2.811748","2":"0.50559753","3":"Top Gun: Maverick","4":"718732821","5":"8.2","6":"753270","7":"2022","8":"130"},{"1":"2.734704","2":"1.15118532","3":"Star Wars: Episode VII - The Force Awakens","4":"936662225","5":"7.8","6":"991722","7":"2015","8":"138"},{"1":"2.614653","2":"0.49672181","3":"Inside Out 2","4":"652980194","5":"7.6","6":"199450","7":"2024","8":"96"},{"1":"2.320801","2":"-0.03222423","3":"Moana 2","4":"445091599","5":"7.0","6":"66256","7":"2024","8":"100"},{"1":"2.280776","2":"0.83200049","3":"Jurassic World","4":"653406625","5":"6.9","6":"694693","7":"2015","8":"124"},{"1":"2.279169","2":"0.55893692","3":"The Super Mario Bros. Movie","4":"574934330","5":"7.0","6":"258483","7":"2023","8":"92"},{"1":"2.236211","2":"0.82111554","3":"Deadpool & Wolverine","4":"636745858","5":"7.6","6":"454957","7":"2024","8":"128"},{"1":"2.203411","2":"1.05854689","3":"Black Panther","4":"700426566","5":"7.3","6":"861789","7":"2018","8":"134"},{"1":"2.203181","2":"0.51476371","3":"The Lion King","4":"543638043","5":"6.8","6":"278229","7":"2019","8":"118"},{"1":"2.192322","2":"1.50618592","3":"Avengers: Endgame","4":"858373000","5":"8.4","6":"1327991","7":"2019","8":"181"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">augment</span>(lm_gross_fit, gross_dat) <span class="sc">%&gt;%</span> </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_min</span>(.resid, <span class="at">n=</span><span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(.resid, .pred, primaryTitle<span class="sc">:</span>runtimeMinutes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false"> <div class="table-caption"><p>Predicting lifetime gross - Lowest residuals</p></div>
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[".resid"],"name":[1],"type":["dbl"],"align":["right"]},{"label":[".pred"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["primaryTitle"],"name":[3],"type":["chr"],"align":["left"]},{"label":["gross"],"name":[4],"type":["int"],"align":["right"]},{"label":["averageRating"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["numVotes"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["startYear"],"name":[7],"type":["int"],"align":["right"]},{"label":["runtimeMinutes"],"name":[8],"type":["int"],"align":["right"]}],"data":[{"1":"-1.882086","2":"0.7176603","3":"Oblivion","4":"89107235","5":"7.0","6":"565448","7":"2013","8":"124"},{"1":"-1.865210","2":"1.1313674","3":"Dune: Part One","4":"108897830","5":"8.0","6":"932875","7":"2021","8":"155"},{"1":"-1.733344","2":"0.8209311","3":"Edge of Tomorrow","4":"100206256","5":"7.9","6":"762503","7":"2014","8":"113"},{"1":"-1.715188","2":"0.4705222","3":"Alita: Battle Angel","4":"85838210","5":"7.3","6":"307308","7":"2019","8":"122"},{"1":"-1.673445","2":"0.4889374","3":"Back to the Future Part III","4":"88277583","5":"7.5","6":"494717","7":"1990","8":"118"},{"1":"-1.673343","2":"0.6888763","3":"Schindler's List","4":"96898818","5":"9.0","6":"1500915","7":"1993","8":"195"},{"1":"-1.648807","2":"0.7370070","3":"Kingsman: The Golden Circle","4":"100234838","5":"6.7","6":"379505","7":"2017","8":"141"},{"1":"-1.626320","2":"0.7478442","3":"Pacific Rim","4":"101802906","5":"6.9","6":"541497","7":"2013","8":"131"},{"1":"-1.620935","2":"0.5546894","3":"Dungeons & Dragons: Honor Among Thieves","4":"93277026","5":"7.2","6":"251375","7":"2023","8":"134"},{"1":"-1.619005","2":"0.4940252","3":"Prince of Persia: The Sands of Time","4":"90759676","5":"6.5","6":"309476","7":"2010","8":"116"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section>
<section id="average-ratings" class="level2">
<h2 class="anchored" data-anchor-id="average-ratings">Average ratings</h2>
<p>Next up, let’s see if we can predict a movie’s average rating from its number of votes, release year, run time, and genre tags. To start, we’ll create a new data frame by filtering out movies over 5 hours long and those missing a release year, and selecting only the variables we’re interested in.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data set</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>rating_model_dat <span class="ot">&lt;-</span> title_dat <span class="sc">%&gt;%</span> </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(runtimeMinutes <span class="sc">&lt;</span> <span class="dv">300</span>,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>         <span class="sc">!</span><span class="fu">is.na</span>(startYear)) <span class="sc">%&gt;%</span> </span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(tconst,</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>         primaryTitle,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>         averageRating,</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>         numVotes,</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>         startYear, </span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>         runtimeMinutes, </span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>         <span class="fu">starts_with</span>(<span class="st">"Genre_"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="st">'Genre_News'</span>, <span class="st">'Genre_NA'</span>, </span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Genre_Talk-Show'</span>, <span class="st">'Genre_Reality-TV'</span>, <span class="st">'Genre_Game-Show'</span>))</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(rating_model_dat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 44,608
Columns: 29
$ tconst            &lt;chr&gt; "tt0002130", "tt0002423", "tt0002844", "tt0003014", …
$ primaryTitle      &lt;chr&gt; "Dante's Inferno", "Passion", "Fantômas: In the Shad…
$ averageRating     &lt;dbl&gt; 7.0, 6.6, 6.9, 7.0, 6.9, 6.9, 6.4, 6.4, 7.1, 6.0, 6.…
$ numVotes          &lt;dbl&gt; 3704, 1049, 2598, 1493, 1765, 1405, 2522, 1493, 4095…
$ startYear         &lt;int&gt; 1911, 1919, 1913, 1913, 1913, 1913, 1913, 1914, 1914…
$ runtimeMinutes    &lt;int&gt; 71, 113, 54, 96, 61, 90, 85, 78, 148, 52, 59, 70, 60…
$ Genre_Romance     &lt;dbl&gt; 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0…
$ Genre_Documentary &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ Genre_Sport       &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ Genre_Action      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0…
$ Genre_Adventure   &lt;dbl&gt; 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0…
$ Genre_Biography   &lt;dbl&gt; 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ Genre_Drama       &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1…
$ Genre_Fantasy     &lt;dbl&gt; 1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0…
$ Genre_Comedy      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0…
$ Genre_War         &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1…
$ Genre_Crime       &lt;dbl&gt; 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0…
$ Genre_Family      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ Genre_History     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ `Genre_Sci-Fi`    &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ Genre_Thriller    &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ Genre_Western     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ Genre_Mystery     &lt;dbl&gt; 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ Genre_Horror      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0…
$ Genre_Music       &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ Genre_Animation   &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ Genre_Musical     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ `Genre_Film-Noir` &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ Genre_Adult       &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…</code></pre>
</div>
</div>
<p>Next, we’ll split this data set into a <em>training</em> and a <em>test</em> set. The training set will used to train our models (hence the name); the test set will be used to evaluate how well they generalize to new data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1337</span>) <span class="co"># Set seed for reproducibility</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>rating_data_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(rating_model_dat, <span class="at">prop =</span> <span class="dv">3</span><span class="sc">/</span><span class="dv">4</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>rating_data_train <span class="ot">&lt;-</span> <span class="fu">training</span>(rating_data_split)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>rating_data_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(rating_data_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we’ll specify a data pre-processing recipe that will:</p>
<ul>
<li>Predict average rating (<code>averageRating</code>) from all other predictors</li>
<li>Treat <code>tconst</code> and <code>primaryTitle</code> as identifiers</li>
<li>Log-transform <code>numVotes</code> to handle deviation from normality</li>
<li>Normalize all continuous predictors (i.e., convert to z-scores)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the recipe</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>rating_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(averageRating <span class="sc">~</span> ., rating_model_dat) <span class="sc">%&gt;%</span> <span class="co"># Set formula</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(tconst, primaryTitle, <span class="at">new_role =</span> <span class="st">"ID"</span>) <span class="sc">%&gt;%</span> <span class="co"># Treat as identifiers</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_log</span>(numVotes) <span class="sc">%&gt;%</span> <span class="co"># Log transform to address deviation from normality</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(startYear, runtimeMinutes, numVotes) <span class="sc">%&gt;%</span> <span class="co"># Normalize continuous</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_zv</span>(<span class="fu">all_predictors</span>()) <span class="co"># Remove predictors with no variance</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can reuse our work here with each model we run – this is one of the big advantages of <code>tidymodels</code>!</p>
<section id="linear-model" class="level3">
<h3 class="anchored" data-anchor-id="linear-model">Linear model</h3>
<p>First, let’s fit a linear model to our training data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit model</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>lm_rating_fit <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> <span class="co"># Set up workflow</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(<span class="fu">linear_reg</span>()) <span class="sc">%&gt;%</span> <span class="co"># Use linear regression</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(rating_rec) <span class="sc">%&gt;%</span>  <span class="co"># Use our pre-processing recipe</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">data =</span> rating_data_train) <span class="co"># Use training data set</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Check results</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>lm_rating_fit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>══ Workflow [trained] ══════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: linear_reg()

── Preprocessor ────────────────────────────────────────────────────────────────
3 Recipe Steps

• step_log()
• step_normalize()
• step_zv()

── Model ───────────────────────────────────────────────────────────────────────

Call:
stats::lm(formula = ..y ~ ., data = data)

Coefficients:
      (Intercept)           numVotes          startYear     runtimeMinutes  
        6.3188238          0.3084472         -0.3053317          0.2743756  
    Genre_Romance  Genre_Documentary        Genre_Sport       Genre_Action  
       -0.1205021          1.2775734         -0.1144554         -0.4181589  
  Genre_Adventure    Genre_Biography        Genre_Drama      Genre_Fantasy  
       -0.2825614          0.0420595          0.3336779         -0.2016875  
     Genre_Comedy          Genre_War        Genre_Crime       Genre_Family  
       -0.1212918         -0.0385408         -0.0321719         -0.1483447  
    Genre_History     `Genre_Sci-Fi`     Genre_Thriller      Genre_Western  
        0.0004387         -0.4777811         -0.1628879         -0.2258474  
    Genre_Mystery       Genre_Horror        Genre_Music    Genre_Animation  
       -0.0542027         -0.7826594         -0.0658001          0.8431900  
    Genre_Musical  `Genre_Film-Noir`  
       -0.1518250         -0.0612570  </code></pre>
</div>
</div>
<p>As we did for the lifetime gross model, let’s visualize via a dot-and-whisker plot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>broom.mixed<span class="sc">::</span><span class="fu">tidy</span>(lm_rating_fit, <span class="at">conf.int =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(estimate) <span class="sc">%&gt;%</span> </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(estimate)) <span class="sc">%&gt;%</span> </span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  dotwhisker<span class="sc">::</span><span class="fu">dwplot</span>(<span class="at">dot_args =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">"black"</span>),</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">whisker_args =</span> <span class="fu">list</span>(<span class="at">color =</span> <span class="st">"black"</span>),</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">vline =</span> <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">colour =</span> <span class="st">"grey50"</span>, <span class="at">linetype =</span> <span class="dv">2</span>)) <span class="sc">+</span> </span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Predicting average ratings"</span>, <span class="at">subtitle =</span> <span class="st">"Linear model"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Out of curiosity, let’s see the 20 movies with the lowest (most) negative residuals – in other words, the movies for which our model most overestimated ratings:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">augment</span>(lm_rating_fit, rating_model_dat) <span class="sc">%&gt;%</span> </span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_min</span>(.resid, <span class="at">n=</span><span class="dv">20</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(.pred, .resid, primaryTitle<span class="sc">:</span>runtimeMinutes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false"> <div class="table-caption"><p>Predicting average ratings - Lowest residuals</p></div>
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[".pred"],"name":[1],"type":["dbl"],"align":["right"]},{"label":[".resid"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["primaryTitle"],"name":[3],"type":["chr"],"align":["left"]},{"label":["averageRating"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["numVotes"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["startYear"],"name":[6],"type":["int"],"align":["right"]},{"label":["runtimeMinutes"],"name":[7],"type":["int"],"align":["right"]}],"data":[{"1":"7.952335","2":"-6.252335","3":"Justin Bieber: Never Say Never","4":"1.7","5":"76511","6":"2011","7":"105"},{"1":"7.066869","2":"-6.066869","3":"Reis","4":"1.0","5":"74214","6":"2017","7":"108"},{"1":"7.456796","2":"-5.856796","3":"Justin Bieber's Believe","4":"1.6","5":"17955","6":"2013","7":"92"},{"1":"7.348169","2":"-5.748169","3":"Jonas Brothers: The 3D Concert Experience","4":"1.6","5":"17567","6":"2009","7":"76"},{"1":"6.934861","2":"-5.734861","3":"Sadak 2","4":"1.2","5":"96910","6":"2020","7":"133"},{"1":"6.895741","2":"-5.695741","3":"Smolensk","4":"1.2","5":"40253","6":"2016","7":"120"},{"1":"7.026134","2":"-5.626134","3":"The Legend of the Titanic","4":"1.4","5":"3678","6":"1999","7":"84"},{"1":"7.448394","2":"-5.548394","3":"The Undefeated","4":"1.9","5":"1967","6":"2011","7":"118"},{"1":"6.465751","2":"-5.465751","3":"321 Action","4":"1.0","5":"10229","6":"2020","7":"100"},{"1":"6.336742","2":"-5.336742","3":"Cumali Ceber","4":"1.0","5":"39516","6":"2017","7":"100"},{"1":"7.012994","2":"-5.312994","3":"Humshakals","4":"1.7","5":"8972","6":"2014","7":"159"},{"1":"7.108319","2":"-5.308319","3":"Amazing China","4":"1.8","5":"3910","6":"2018","7":"90"},{"1":"6.757634","2":"-5.257634","3":"Titanic: The Legend Goes On...","4":"1.5","5":"9716","6":"2000","7":"90"},{"1":"6.493090","2":"-5.193090","3":"A Fox's Tale","4":"1.3","5":"9092","6":"2008","7":"85"},{"1":"6.718127","2":"-5.118127","3":"The Starfighters","4":"1.6","5":"3551","6":"1964","7":"78"},{"1":"6.605966","2":"-5.105966","3":"The Cost of Deception","4":"1.5","5":"40691","6":"2021","7":"125"},{"1":"6.194956","2":"-5.094956","3":"Nyay: The Justice","4":"1.1","5":"1678","6":"2021","7":"110"},{"1":"6.306746","2":"-5.006746","3":"Foodfight!","4":"1.3","5":"12202","6":"2012","7":"91"},{"1":"6.503381","2":"-5.003381","3":"The Trump Prophecy","4":"1.5","5":"2710","6":"2018","7":"120"},{"1":"7.598502","2":"-4.998502","3":"Buck Breaking","4":"2.6","5":"1036","6":"2021","7":"155"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>The presence of two Justin Bieber films near the top of the list jumps out at me, as do the titles “The Trump Prophecy” and “Buck Breaking”. If I had to guess, we’re seeing films that have attracted more (negative) attention due to their content than would be expected based purely on the variables available to our model. This highlights a crucial shortcoming of our model: other than the genre tags, it doesn’t incorporate any information about what the films are actually <em>about</em>.</p>
<p>Same thing, but now the highest residuals:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">augment</span>(lm_rating_fit, rating_model_dat) <span class="sc">%&gt;%</span> </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(.resid, <span class="at">n=</span><span class="dv">20</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(.pred, .resid, primaryTitle<span class="sc">:</span>runtimeMinutes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false"> <div class="table-caption"><p>Predicting average ratings - Highest residuals</p></div>
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[".pred"],"name":[1],"type":["dbl"],"align":["right"]},{"label":[".resid"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["primaryTitle"],"name":[3],"type":["chr"],"align":["left"]},{"label":["averageRating"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["numVotes"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["startYear"],"name":[6],"type":["int"],"align":["right"]},{"label":["runtimeMinutes"],"name":[7],"type":["int"],"align":["right"]}],"data":[{"1":"4.483153","2":"4.416847","3":"River Beauty","4":"8.9","5":"1036","6":"2023","7":"90"},{"1":"4.847855","2":"4.252145","3":"Akkada Varu Ikkada Unnaru","4":"9.1","5":"1030","6":"2024","7":"103"},{"1":"5.261594","2":"3.838406","3":"Kaveri","4":"9.1","5":"1463","6":"2024","7":"101"},{"1":"5.488597","2":"3.711403","3":"Ennu Swantham Punyalan","4":"9.2","5":"1354","6":"2025","7":"127"},{"1":"5.794335","2":"3.705665","3":"Jithender Reddy","4":"9.5","5":"2303","6":"2024","7":"136"},{"1":"5.714118","2":"3.685882","3":"Devaki Nandana Vasudeva","4":"9.4","5":"2527","6":"2024","7":"128"},{"1":"5.433433","2":"3.666567","3":"Antha Naal","4":"9.1","5":"1177","6":"2024","7":"98"},{"1":"5.387368","2":"3.612632","3":"Hide N Seek","4":"9.0","5":"2120","6":"2024","7":"134"},{"1":"5.290156","2":"3.609844","3":"Thursday","4":"8.9","5":"4813","6":"2006","7":"89"},{"1":"5.234139","2":"3.565861","3":"Darshini","4":"8.8","5":"2128","6":"2024","7":"120"},{"1":"6.320235","2":"3.479765","3":"Nimma Vasthugalige Neeve Javaabdaararu","4":"9.8","5":"2685","6":"2025","7":"132"},{"1":"6.154545","2":"3.445455","3":"Nesippaya","4":"9.6","5":"2057","6":"2025","7":"144"},{"1":"5.956542","2":"3.443458","3":"Va Varalam Va","4":"9.4","5":"1166","6":"2023","7":"139"},{"1":"5.370231","2":"3.429769","3":"Raktaksha","4":"8.8","5":"1349","6":"2024","7":"118"},{"1":"4.712875","2":"3.387125","3":"Bairan Palli","4":"8.1","5":"2240","6":"2023","7":"91"},{"1":"5.727435","2":"3.372565","3":"Paagal vs Kadhal","4":"9.1","5":"2049","6":"2024","7":"111"},{"1":"6.146140","2":"3.353860","3":"Strawberry Melancholy","4":"9.5","5":"4191","6":"2007","7":"112"},{"1":"5.247476","2":"3.352524","3":"Rhino King","4":"8.6","5":"1212","6":"2025","7":"90"},{"1":"5.850483","2":"3.349517","3":"Thiru.Manickam","4":"9.2","5":"2052","6":"2024","7":"122"},{"1":"5.757592","2":"3.342408","3":"Song Without Words","4":"9.1","5":"1112","6":"2022","7":"83"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>These appear to be mainly non-English titles, released recently, with relatively few votes (recall that our threshold for inclusion in the data set was 1000 votes).</p>
</section>
<section id="random-forest" class="level3">
<h3 class="anchored" data-anchor-id="random-forest">Random forest</h3>
<p>With only a few extra lines of code, we can run the same analysis using a different model! Let’s try a random forest model – all we need to do is set up the engine we want to use (<code>ranger</code>), specifying the mode (<code>regression</code>, since our outcome is continuous), the number of trees (<code>trees</code>), and the method to be used to assess variable importance (<code>importance</code>)<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the engine</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>rf_mod <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>(<span class="at">mode =</span> <span class="st">"regression"</span>, <span class="at">trees =</span> <span class="dv">1000</span>) <span class="sc">%&gt;%</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"ranger"</span>, <span class="at">importance=</span><span class="st">"impurity"</span>) </span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Set workflow and fit model</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>rf_rating_fit <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(rf_mod) <span class="sc">%&gt;%</span> </span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(rating_rec) <span class="sc">%&gt;%</span> <span class="co"># Same recipe as before! </span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">data =</span> rating_data_train)</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>rf_rating_fit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>══ Workflow [trained] ══════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: rand_forest()

── Preprocessor ────────────────────────────────────────────────────────────────
3 Recipe Steps

• step_log()
• step_normalize()
• step_zv()

── Model ───────────────────────────────────────────────────────────────────────
Ranger result

Call:
 ranger::ranger(x = maybe_data_frame(x), y = y, num.trees = ~1000,      importance = ~"impurity", num.threads = 1, verbose = FALSE,      seed = sample.int(10^5, 1)) 

Type:                             Regression 
Number of trees:                  1000 
Sample size:                      33456 
Number of independent variables:  25 
Mtry:                             5 
Target node size:                 5 
Variable importance mode:         impurity 
Splitrule:                        variance 
OOB prediction error (MSE):       0.7761085 
R squared (OOB):                  0.442483 </code></pre>
</div>
</div>
</section>
<section id="xgboost" class="level3">
<h3 class="anchored" data-anchor-id="xgboost">XGBoost</h3>
<p>We’ll fit a third model using XGBoost:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the engine</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>xgb_mod <span class="ot">&lt;-</span> <span class="fu">boost_tree</span>(<span class="at">engine =</span> <span class="st">"xgboost"</span>, <span class="at">mode =</span> <span class="st">"regression"</span>, <span class="at">trees =</span> <span class="dv">1000</span>)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Set workflow and fit model</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>xgb_rating_fit <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(xgb_mod) <span class="sc">%&gt;%</span> <span class="co"># Use XGBoost</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(rating_rec) <span class="sc">%&gt;%</span>  <span class="co"># Same recipe as before!</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">data =</span> rating_data_train)</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>xgb_rating_fit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>══ Workflow [trained] ══════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: boost_tree()

── Preprocessor ────────────────────────────────────────────────────────────────
3 Recipe Steps

• step_log()
• step_normalize()
• step_zv()

── Model ───────────────────────────────────────────────────────────────────────
##### xgb.Booster
raw: 3.7 Mb 
call:
  xgboost::xgb.train(params = list(eta = 0.3, max_depth = 6, gamma = 0, 
    colsample_bytree = 1, colsample_bynode = 1, min_child_weight = 1, 
    subsample = 1), data = x$data, nrounds = 1000, watchlist = x$watchlist, 
    verbose = 0, nthread = 1, objective = "reg:squarederror")
params (as set within xgb.train):
  eta = "0.3", max_depth = "6", gamma = "0", colsample_bytree = "1", colsample_bynode = "1", min_child_weight = "1", subsample = "1", nthread = "1", objective = "reg:squarederror", validate_parameters = "TRUE"
xgb.attributes:
  niter
callbacks:
  cb.evaluation.log()
# of features: 25 
niter: 1000
nfeatures : 25 
evaluation_log:
  iter training_rmse
 &lt;num&gt;         &lt;num&gt;
     1     4.1600833
     2     2.9903320
   ---           ---
   999     0.4058402
  1000     0.4054915</code></pre>
</div>
</div>
</section>
<section id="compare" class="level3">
<h3 class="anchored" data-anchor-id="compare">Compare</h3>
<section id="metrics" class="level4">
<h4 class="anchored" data-anchor-id="metrics">Metrics</h4>
<p>To compare our models, we first define a set of metrics:</p>
<ul>
<li>Root mean square deviation (<code>rmse</code>): measures the deviation between observed and model-predicted values. Smaller values represent better fit; a value of 0 (impossible in practice) would represent perfect fit.</li>
<li>R-squared (<code>rsq</code>): proportion of variance in outcome variable predicted by the model. Ranges from 0.0 to 1.0; larger values represent better fit, with a value of 1.0 (impossible in practice) representing perfect fit.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define metrics</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>rating_metrics <span class="ot">&lt;-</span> <span class="fu">metric_set</span>(rmse, rsq)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we loop over a list of our models, using the <code>augment()</code> function to calculate these metrics for each model. First, let’s see what happens if we calculate these metrics using the <em>training</em> data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make list of models</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>rating_models <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">"Linear"</span><span class="ot">=</span>lm_rating_fit,</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"Random Forest"</span><span class="ot">=</span>rf_rating_fit,</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"XGBoost"</span> <span class="ot">=</span> xgb_rating_fit)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>rating_models <span class="sc">%&gt;%</span> </span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(\(model) </span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">augment</span>(model, rating_data_train) <span class="sc">%&gt;%</span> <span class="co"># Use training data</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rating_metrics</span>(averageRating, .pred)) <span class="sc">%&gt;%</span> </span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list_rbind</span>(<span class="at">names_to =</span> <span class="st">"Model"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>.estimator) <span class="sc">%&gt;%</span> </span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> .metric, <span class="at">values_from =</span> .estimate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false"> <div class="table-caption"><p>Predicting average ratings - Model metrics (training data)</p></div>
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["Model"],"name":[1],"type":["chr"],"align":["left"]},{"label":["rmse"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["rsq"],"name":[3],"type":["dbl"],"align":["right"]}],"data":[{"1":"Linear","2":"0.9321806","3":"0.3757640"},{"1":"Random Forest","2":"0.6902310","3":"0.6885842"},{"1":"XGBoost","2":"0.4054915","3":"0.8919465"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>XGBoost appears superior by both metrics, but there’s a big caveat – models such as XGBoost (and random forests, to a lesser extent) are prone to <em>overfitting</em>, meaning that their predictions can be hyper-specialized for the data they were trained upon (e.g., <code>rating_data_train</code>) at the expense of their ability to generalize to novel data. To check, we’ll calculate our metrics again, but this time we’ll use our <em>test</em> data (<code>rating_data_test</code>):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>rating_models <span class="sc">%&gt;%</span> </span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(\(model) </span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>      <span class="fu">augment</span>(model, rating_data_test) <span class="sc">%&gt;%</span> <span class="co"># Use test data</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rating_metrics</span>(averageRating, .pred)) <span class="sc">%&gt;%</span> </span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list_rbind</span>(<span class="at">names_to =</span> <span class="st">"Model"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>.estimator) <span class="sc">%&gt;%</span> </span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> .metric, <span class="at">values_from =</span> .estimate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false"> <div class="table-caption"><p>Predicting average ratings - Model metrics (test data)</p></div>
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["Model"],"name":[1],"type":["chr"],"align":["left"]},{"label":["rmse"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["rsq"],"name":[3],"type":["dbl"],"align":["right"]}],"data":[{"1":"Linear","2":"0.9240641","3":"0.3819300"},{"1":"Random Forest","2":"0.8699871","3":"0.4543605"},{"1":"XGBoost","2":"0.9394241","3":"0.3844094"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Note that our linear model performs roughly the same, but our random forest and XGBoost models show decreased performance. In particular, while XGBoost appeared to outperform the random forest model on the training data, it performs roughly equivalent to the linear model on the test data.</p>
<p>The takeaway here is that estimating our metrics based on the <em>training</em> data inflated the performance of our random forest and (in particular) XGBoost models; using the <em>test</em> data gives a much more accurate estimate of our metrics.</p>
</section>
<section id="variable-importance" class="level4">
<h4 class="anchored" data-anchor-id="variable-importance">Variable importance</h4>
<p>We can use the <code>vip</code> package to get estimates of variable importance from each of our models, then plot them together:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>rating_models <span class="sc">%&gt;%</span> </span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(\(model) vip<span class="sc">::</span><span class="fu">vi</span>(model,<span class="at">scale =</span> T)) <span class="sc">%&gt;%</span> <span class="co"># Scale makes estimates comparable</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list_rbind</span>(<span class="at">names_to =</span> <span class="st">"Model"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span><span class="fu">fct_reorder</span>(Variable, Importance, mean), <span class="co"># Order by mean</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">y =</span> Importance, </span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">fill =</span> Model, <span class="at">color =</span> Model, <span class="at">shape =</span> Model)) <span class="sc">+</span> </span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha=</span><span class="fl">0.8</span>, <span class="at">size=</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span> </span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Predicting average rating - Variable importance"</span>,</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Variable"</span>, <span class="at">y =</span> <span class="st">"Importance (scaled)"</span>,</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">"Variables in descending order of mean importance"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>There’s some divergence between the three models, but overall, number of votes, run time, and release year seem to be the most important predictors across models.</p>
</section>
<section id="predicted-versus-observed-ratings" class="level4">
<h4 class="anchored" data-anchor-id="predicted-versus-observed-ratings">Predicted versus observed ratings</h4>
<p>Lastly, let’s compare the predicted versus observed ratings for each of our three models:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>rating_models <span class="sc">%&gt;%</span> </span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(\(model) <span class="fu">augment</span>(model, rating_data_test)) <span class="sc">%&gt;%</span> </span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list_rbind</span>(<span class="at">names_to=</span><span class="st">"Model"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>.pred,<span class="at">y=</span>averageRating))<span class="sc">+</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hex</span>()<span class="sc">+</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>() <span class="sc">+</span> </span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>()<span class="sc">+</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">"Predicted average rating"</span>,<span class="at">y=</span><span class="st">"Average rating"</span>, <span class="at">fill =</span> <span class="st">"Frequency"</span>,</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Predicting average rating - Predicted versus observed ratings"</span>)<span class="sc">+</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Model,<span class="at">nrow =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"inside"</span>, <span class="at">legend.position.inside =</span> <span class="fu">c</span>(.<span class="dv">75</span>,.<span class="dv">25</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The more closely the distribution follows the diagonal line, the more closely the predicted ratings match the observed ratings. Overall, the XGBoost model seems to have a slight advantage.</p>
</section>
</section>
</section>
<section id="predicting-genre" class="level2">
<h2 class="anchored" data-anchor-id="predicting-genre">Predicting genre</h2>
<p>All of our models thus far have examined continuous outcomes. Now, let’s try some models with a categorical outcome. Specifically, let’s see if we can predict whether or not a movie is classified as a drama based on the variables available to us! As with the previous example, we’ll run three models and compare the results: binary logistic regression (GLM), random forest, and XGBoost.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define our data set</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>drama_model_dat <span class="ot">&lt;-</span> rating_model_dat <span class="sc">%&gt;%</span> </span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Drama =</span> <span class="fu">factor</span>(Genre_Drama, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"no"</span>,<span class="st">"yes"</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>Genre_Drama)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Split data into training/testing sets</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting `strata = Drama` ensures that proportion of positive cases</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="co"># is roughly equal in training vs test set</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1337</span>)</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>genre_data_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(drama_model_dat, <span class="at">strata =</span> Drama)</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>genre_data_train <span class="ot">&lt;-</span> <span class="fu">training</span>(genre_data_split)</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>genre_data_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(genre_data_split)</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the recipe</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>genre_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Drama <span class="sc">~</span> ., genre_data_train) <span class="sc">%&gt;%</span> </span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_log</span>(numVotes) <span class="sc">%&gt;%</span> </span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(averageRating,startYear,runtimeMinutes,numVotes) <span class="sc">%&gt;%</span> </span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(tconst,primaryTitle,<span class="at">new_role =</span> <span class="st">"ID"</span>) <span class="co"># Treat as identifiers</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="glm" class="level3">
<h3 class="anchored" data-anchor-id="glm">GLM</h3>
<p>Setting up the engine for GLM is straightforward; we technically don’t need to specify <code>mode</code> or <code>engine</code>, since <code>logistic_reg()</code> defaults to <code>mode = "classification"</code> and <code>engine = "glm"</code>, but I’ve included them here for completeness.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the engine</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>genre_mod <span class="ot">&lt;-</span> <span class="fu">logistic_reg</span>(<span class="at">mode =</span> <span class="st">"classification"</span>,</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">engine =</span> <span class="st">"glm"</span>)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the workflow</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>genre_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(genre_mod) <span class="sc">%&gt;%</span> </span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(genre_rec)</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit model</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>genre_fit <span class="ot">&lt;-</span> genre_workflow <span class="sc">%&gt;%</span> </span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">data =</span> genre_data_train)</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Check results</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>genre_fit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>══ Workflow [trained] ══════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: logistic_reg()

── Preprocessor ────────────────────────────────────────────────────────────────
2 Recipe Steps

• step_log()
• step_normalize()

── Model ───────────────────────────────────────────────────────────────────────

Call:  stats::glm(formula = ..y ~ ., family = stats::binomial, data = data)

Coefficients:
      (Intercept)      averageRating           numVotes          startYear  
          3.75923            0.45874            0.09723            0.10283  
   runtimeMinutes      Genre_Romance  Genre_Documentary        Genre_Sport  
          0.20793           -0.54392           -6.32332           -0.89793  
     Genre_Action    Genre_Adventure    Genre_Biography      Genre_Fantasy  
         -1.91524           -1.75050           -0.18449           -1.18757  
     Genre_Comedy          Genre_War        Genre_Crime       Genre_Family  
         -3.16581           -0.39853           -0.71781           -1.32834  
    Genre_History     `Genre_Sci-Fi`     Genre_Thriller      Genre_Western  
         -0.37178           -2.00270           -2.29839           -2.35082  
    Genre_Mystery       Genre_Horror        Genre_Music    Genre_Animation  
         -0.94367           -2.74321           -0.47075           -2.35175  
    Genre_Musical  `Genre_Film-Noir`        Genre_Adult  
         -1.57199           -0.31297                 NA  

Degrees of Freedom: 33454 Total (i.e. Null);  33429 Residual
Null Deviance:      46010 
Residual Deviance: 28000    AIC: 28050</code></pre>
</div>
</div>
</section>
<section id="random-forest-1" class="level3">
<h3 class="anchored" data-anchor-id="random-forest-1">Random forest</h3>
<p>For a random forest model, we’ll pass a few more arguments to set up the engine.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the engine</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>genre_rf <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>(<span class="at">trees =</span> <span class="dv">1000</span>) <span class="sc">%&gt;%</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"ranger"</span>, <span class="at">importance=</span><span class="st">"impurity"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the workflow</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>genre_workflow_rf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(genre_rf) <span class="sc">%&gt;%</span> </span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(genre_rec)</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a><span class="co"># # Finalize model and fit</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>genre_fit_rf <span class="ot">&lt;-</span> genre_workflow_rf <span class="sc">%&gt;%</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">data =</span> genre_data_train)</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Check results</span></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>genre_fit_rf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>══ Workflow [trained] ══════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: rand_forest()

── Preprocessor ────────────────────────────────────────────────────────────────
2 Recipe Steps

• step_log()
• step_normalize()

── Model ───────────────────────────────────────────────────────────────────────
Ranger result

Call:
 ranger::ranger(x = maybe_data_frame(x), y = y, num.trees = ~1000,      importance = ~"impurity", num.threads = 1, verbose = FALSE,      seed = sample.int(10^5, 1), probability = TRUE) 

Type:                             Probability estimation 
Number of trees:                  1000 
Sample size:                      33455 
Number of independent variables:  26 
Mtry:                             5 
Target node size:                 10 
Variable importance mode:         impurity 
Splitrule:                        gini 
OOB prediction error (Brier s.):  0.1170917 </code></pre>
</div>
</div>
</section>
<section id="xgboost-1" class="level3">
<h3 class="anchored" data-anchor-id="xgboost-1">XGBoost</h3>
<p>Lastly, let’s run an XGBoost model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>genre_xgb <span class="ot">&lt;-</span> <span class="fu">boost_tree</span>() <span class="sc">%&gt;%</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"xgboost"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the workflow</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>genre_workflow_xgb <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(genre_xgb) <span class="sc">%&gt;%</span> </span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(genre_rec)</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Finalize model and fit</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>genre_fit_xgb <span class="ot">&lt;-</span> genre_workflow_xgb <span class="sc">%&gt;%</span> </span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">data =</span> genre_data_train)</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>genre_fit_xgb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>══ Workflow [trained] ══════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: boost_tree()

── Preprocessor ────────────────────────────────────────────────────────────────
2 Recipe Steps

• step_log()
• step_normalize()

── Model ───────────────────────────────────────────────────────────────────────
##### xgb.Booster
raw: 61.5 Kb 
call:
  xgboost::xgb.train(params = list(eta = 0.3, max_depth = 6, gamma = 0, 
    colsample_bytree = 1, colsample_bynode = 1, min_child_weight = 1, 
    subsample = 1), data = x$data, nrounds = 15, watchlist = x$watchlist, 
    verbose = 0, nthread = 1, objective = "binary:logistic")
params (as set within xgb.train):
  eta = "0.3", max_depth = "6", gamma = "0", colsample_bytree = "1", colsample_bynode = "1", min_child_weight = "1", subsample = "1", nthread = "1", objective = "binary:logistic", validate_parameters = "TRUE"
xgb.attributes:
  niter
callbacks:
  cb.evaluation.log()
# of features: 26 
niter: 15
nfeatures : 26 
evaluation_log:
  iter training_logloss
 &lt;num&gt;            &lt;num&gt;
     1        0.5921049
     2        0.5357200
   ---              ---
    14        0.3776050
    15        0.3730612</code></pre>
</div>
</div>
</section>
<section id="compare-1" class="level3">
<h3 class="anchored" data-anchor-id="compare-1">Compare</h3>
<section id="metrics-1" class="level4">
<h4 class="anchored" data-anchor-id="metrics-1">Metrics</h4>
<p>As previously, we’ll define a set of metrics to compare our model:</p>
<ul>
<li>Accuracy (<code>accuracy</code>): measures the proportion of cases that are predicted correctly. Values closer to 1.00 indicate greater accuracy.</li>
<li>Kappa (<code>kap</code>): like accuracy, but adjusted based on the proportion of correct predictions that would be expected due to chance alone.</li>
<li>Sensitivity (<code>sensitivity</code>): the number of <em>predicted positives</em> divided by the number of <em>actual positives</em>. In our case, what proportion of films with the “drama” tag did our models correctly predict as dramas?</li>
<li>Specificity (<code>specificity</code>): the number of <em>predicted negatives</em> divided by the number of <em>actual negatives</em>. In our case, what proportion of non-drama films did our models correctly predict as non-dramas?</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define metrics</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>genre_metrics <span class="ot">&lt;-</span> <span class="fu">metric_set</span>(</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  yardstick<span class="sc">::</span>accuracy,</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  kap, </span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>  sensitivity,</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>  specificity</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Make list of models, augment with predictions</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>genre_models_augmented <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">"GLM"</span><span class="ot">=</span>genre_fit,</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"Random Forest"</span><span class="ot">=</span>genre_fit_rf,</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"XGBoost"</span><span class="ot">=</span>genre_fit_xgb) <span class="sc">%&gt;%</span> </span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(\(model) <span class="fu">augment</span>(model, genre_data_test)) <span class="co"># Get predictions from test dat</span></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Get metrics</span></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>genre_models_augmented <span class="sc">%&gt;%</span> </span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(\(model) <span class="fu">genre_metrics</span>(model, <span class="at">truth =</span> Drama, <span class="at">estimate =</span>.pred_class)) <span class="sc">%&gt;%</span> </span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list_rbind</span>(<span class="at">names_to =</span> <span class="st">"Model"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>.estimator) <span class="sc">%&gt;%</span> </span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> .metric, <span class="at">values_from =</span> .estimate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false"> <div class="table-caption"><p>Predicting drama - Model metrics</p></div>
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["Model"],"name":[1],"type":["chr"],"align":["left"]},{"label":["accuracy"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["kap"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["sensitivity"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["specificity"],"name":[5],"type":["dbl"],"align":["right"]}],"data":[{"1":"GLM","2":"0.7831077","3":"0.5589493","4":"0.7280737","5":"0.8277318"},{"1":"Random Forest","2":"0.8356496","3":"0.6671247","4":"0.8077693","5":"0.8582562"},{"1":"XGBoost","2":"0.8259661","3":"0.6474449","4":"0.7959551","5":"0.8503004"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Our random forest and XGBoost models appear to perform better than our GLM, but don’t differ substantially from each other.</p>
<p>We can also assess our models in terms of their receiver operating characteristic (ROC) curves. We’ll run <code>roc_curve()</code> on each of our models, then bind the data together and plot with <code>ggplot()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>genre_models_augmented <span class="sc">%&gt;%</span> </span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(<span class="sc">~</span><span class="fu">roc_curve</span>(.x, <span class="at">truth =</span> Drama, .pred_no)) <span class="sc">%&gt;%</span> <span class="co"># Calculate ROC curves</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list_rbind</span>(<span class="at">names_to =</span> <span class="st">"Model"</span>) <span class="sc">%&gt;%</span> <span class="co"># Bind into single data frame</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">-</span>specificity,<span class="at">y=</span>sensitivity,<span class="at">color=</span>Model)) <span class="sc">+</span> </span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="co"># Plot the curves</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">linetype=</span><span class="dv">3</span>) <span class="sc">+</span> <span class="co"># Add diagonal line for reference</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>() <span class="sc">+</span> <span class="co"># Make plot square</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title=</span><span class="st">"Predicting drama - ROC curves by model"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>These curves describe the relationship between a model’s true positive rate (sensitivity) and its false positive rate (1-specificity). If a model predicted a binary outcome purely at random, its true positive rate would always be equal to its false positive rate, and its “curve” would fall on the dotted diagonal line; the better a model predicts the outcome, the farther the curve curves away from the diagonal. Out of our three models, the random forest appears to slightly outperform the XGBoost, and both outperform the GLM, as seen from the fact that their curves bend farther from the diagonal (put another way, for any level of specificity, these models have equal or greater sensitivity than the GLM).</p>
<p>We can quantify the difference between the models’ ROC curves by calculating the area under the curve (AOC) for each model. Values closer to 1.00 indicate greater performance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>genre_models_augmented <span class="sc">%&gt;%</span> </span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(\(model) <span class="fu">roc_auc</span>(model, </span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">truth =</span> Drama, </span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>                       .pred_yes, <span class="at">event_level=</span><span class="st">"second"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list_rbind</span>(<span class="at">names_to =</span> <span class="st">"Model"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false"> <div class="table-caption"><p>Predicting drama - ROC AUC</p></div>
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["Model"],"name":[1],"type":["chr"],"align":["left"]},{"label":[".metric"],"name":[2],"type":["chr"],"align":["left"]},{"label":[".estimator"],"name":[3],"type":["chr"],"align":["left"]},{"label":[".estimate"],"name":[4],"type":["dbl"],"align":["right"]}],"data":[{"1":"GLM","2":"roc_auc","3":"binary","4":"0.8821782"},{"1":"Random Forest","2":"roc_auc","3":"binary","4":"0.9178467"},{"1":"XGBoost","2":"roc_auc","3":"binary","4":"0.9090270"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Here again, the random forest model slightly outperforms the XGBoost model, and both outperform the GLM.</p>
</section>
<section id="variable-importance-1" class="level4">
<h4 class="anchored" data-anchor-id="variable-importance-1">Variable importance</h4>
<p>Finally, let’s plot estimates of variable importance for each model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(<span class="st">"GLM"</span><span class="ot">=</span>genre_fit,</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>     <span class="st">"Random Forest"</span><span class="ot">=</span>genre_fit_rf,</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>     <span class="st">"XGBoost"</span><span class="ot">=</span>genre_fit_xgb) <span class="sc">%&gt;%</span> </span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(\(model) vip<span class="sc">::</span><span class="fu">vi</span>(model,<span class="at">scale =</span> T)) <span class="sc">%&gt;%</span> </span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list_rbind</span>(<span class="at">names_to =</span> <span class="st">"Model"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span><span class="fu">fct_reorder</span>(Variable, Importance, mean), <span class="at">y =</span> Importance, </span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">fill =</span> Model, <span class="at">color =</span> Model, <span class="at">shape =</span> Model)) <span class="sc">+</span> </span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size=</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">"Variable"</span>,</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">y=</span><span class="st">"Importance (scaled)"</span>,</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Predicting drama - Variable importance"</span>,</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">"Variables in descending order of mean importance"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The genre tags for comedy and drama appear to be most important regardless of model; however, estimates of importance for variables like average rating, number of votes, and release year differ substantially by model (higher for random forest and XGBoost, lower for GLM). In a real-world scenario, we’d want to dig deeper, potentially using a permutation-based method to assess the variability of these estimates.</p>
</section>
</section>
</section>
</section>
<section id="wrapping-up" class="level1">
<h1>Wrapping up</h1>
<p>Phew – that was a lot! We began by reading in multiple data sets from IMBD, webscraping lifetime gross data from Box Office Mojo, then joining these to produce a data set of movies that included ratings, director names, and lifetime domestic gross (where available). We then used <code>tidymodels</code> package to set up modelling workflows to predict lifetime gross, average rating, and genre based on all variables available to us. For the latter two, we ran multiple models, then compared performance and estimates of variable importance.</p>
<p>I’m really enjoying what I’ve seen of <code>tidymodels</code> thus far – I find myself spending more time thinking about the model itself, and less time wrestling with the implementation. The ability to quickly switch engines (e.g., from linear regression to random forest to XGBoost) and easily compare results is another huge plus, since it makes it much easier to answer the type of “Hmmm, what if we tried…” questions that arise so often in modelling. I hope to do a deeper dive into <code>tidymodels</code> and its capabilities in a future post!</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>This approach only works for films with a single director; we’ll stick with it here because the alternative would make our data structure more complicated.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>We’ll use Spearman’s rho to estimate correlation since some of our variables aren’t normally distributed.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Many models, including random forest and XGBoost, allow us to set <em>hyperparameters</em> such as the number of trees or the number of predictors to sample at each split. For this post, I’ve manually set the number of trees but left all other hyperparameters at their default values. I’ll cover methods for finding the optimal values for hyperparameters (knowing as <em>tuning</em>) in a future post; I’m skipping over it here because it can be both time- and processor-intensive!<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>